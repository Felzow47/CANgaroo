name: Debug MSYS2 on Windows runner

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  msys2-debug:
    runs-on: windows-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install MSYS2 (if missing) via choco
        shell: pwsh
        run: |
          choco feature enable -n allowGlobalConfirmation
          if (-not (Test-Path 'C:\tools\msys64')) {
            choco install -y msys2
            refreshenv
          } else {
            Write-Host "MSYS2 already installed at C:\tools\msys64"
          }

      - name: Diagnostic: show msys2 bash path & basic files (PowerShell)
        shell: pwsh
        run: |
          $paths = @('C:\tools\msys64\usr\bin\bash.exe','C:\msys64\usr\bin\bash.exe','C:\Program Files\msys64\usr\bin\bash.exe')
          foreach ($p in $paths) {
            Write-Host "Check: $p =>" (Test-Path $p)
          }
          Write-Host "List C:\tools (top):"
          Get-ChildItem -Path C:\tools -Force -ErrorAction SilentlyContinue | Select-Object -First 50 | Format-Table Name,FullName
          Write-Host "Env PATH (first 40 entries):"
          $env:PATH.Split(';') | Select-Object -First 40 | ForEach-Object { Write-Host $_ }

      - name: Diagnostic: run pacman and list /mingw64/bin (MSYS2 shell)
        shell: pwsh
        run: |
          $msys = 'C:\tools\msys64\usr\bin\bash.exe'
          if (-not (Test-Path $msys)) { $msys = 'C:\msys64\usr\bin\bash.exe' }
          if (-not (Test-Path $msys)) { Write-Host "MSYS bash not found at standard locations"; exit 0 }
          & $msys -lc '
            echo "=== which pacman ==="
            which pacman || echo "pacman not found"
            echo "=== pacman -V ==="
            pacman -V || true
            echo "=== which /mingw64/bin/qmake and windeployqt ==="
            which /mingw64/bin/qmake || echo "qmake not found"
            which /mingw64/bin/windeployqt || echo "windeployqt not found"
            echo "=== list /mingw64/bin (top 100) ==="
            ls -l /mingw64/bin | head -n 100 || true
            echo "=== pacman -Sl mingw64 | head (packages index sample) ==="
            pacman -Sl mingw64 2>/dev/null | head -n 200 || echo "could not list repo"
          ' 2>&1 | tee msys2-shell-output.txt

      - name: Collect MSYS2 directories (PowerShell)
        shell: pwsh
        run: |
          $dirs = @('C:\tools\msys64','C:\tools\msys64\usr\bin','C:\tools\msys64\mingw64\bin','C:\msys64','C:\msys64\usr\bin','C:\msys64\mingw64\bin')
          foreach ($d in $dirs) {
            if (Test-Path $d) {
              Write-Host "---- Listing $d (first 200 entries) ----"
              Get-ChildItem -Path $d -Recurse -Depth 1 -ErrorAction SilentlyContinue | Select-Object -First 200 | Format-Table Name,FullName,Length
            } else {
              Write-Host "Not found: $d"
            }
          }

      - name: Upload msys2 debug outputs
        uses: actions/upload-artifact@v4
        with:
          name: msys2-debug
          path: |
            msys2-shell-output.txt
            C:\tools\msys64\usr\bin\bash.exe
            C:\tools\msys64\mingw64\bin
            C:\msys64\usr\bin\bash.exe
            C:\msys64\mingw64\bin
