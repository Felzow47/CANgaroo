# Build CANgaroo on Windows (uses lukka/get-qt to install Qt), run windeployqt and upload zip artifact.
name: Build CANgaroo Windows executable

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: {}

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Qt (lukka/get-qt)
        uses: lukka/get-qt@v3
        with:
          qt-version: '6.6.4'   # ajustez si besoin (ex: 6.6.4)
          host: 'windows'

      - name: Ensure 7zip available (optional)
        run: choco install -y 7zip
        shell: pwsh

      - name: (Optional) Download PCAN Basic SDK into expected path
        run: |
          $pcanUrl = 'http://www.peak-system.com/fileadmin/media/files/pcan-basic.zip'
          $dest = 'src/driver/PeakCanDriver/pcan-basic-api'
          if (-not (Test-Path $dest)) { New-Item -ItemType Directory -Path $dest -Force | Out-Null }
          $zip = 'pcan-basic.zip'
          try {
            Invoke-WebRequest -Uri $pcanUrl -OutFile $zip -UseBasicParsing -ErrorAction Stop
            Expand-Archive -LiteralPath $zip -DestinationPath $dest -Force
            Write-Host "PCAN SDK downloaded and extracted to $dest"
          } catch {
            Write-Host "PCAN download failed or skipped; continuing without PCAN."
          }
        shell: pwsh

      - name: Generate Visual Studio solution with qmake
        run: |
          Write-Host "Running qmake to generate Visual Studio solution..."
          # qmake (qmake6) is provided by get-qt and should be in PATH
          qmake -tp vc src/src.pro -o CANgaroo.sln
        shell: pwsh

      - name: Build solution (Release)
        run: |
          Write-Host "Building solution with msbuild..."
          msbuild CANgaroo.sln /p:Configuration=Release /m
        shell: pwsh

      - name: Find produced executable (detect PE header even if no .exe ext) and copy as CANgaroo.exe
        id: find-exe
        run: |
          Write-Host "Searching for PE files (MZ header)..."
          $candidates = Get-ChildItem -Path . -File -Recurse -ErrorAction SilentlyContinue
          $peFiles = @()
          foreach ($f in $candidates) {
            try {
              $fs = [System.IO.File]::Open($f.FullName, [System.IO.FileMode]::Open, [System.IO.FileAccess]::Read)
              $b1 = $fs.ReadByte(); $b2 = $fs.ReadByte()
              $fs.Close()
              if ($b1 -eq 0x4D -and $b2 -eq 0x5A) { $peFiles += $f }
            } catch { }
          }
          if ($peFiles.Count -eq 0) {
            Write-Error "No PE file found. Build may have failed or produced a non-Windows binary."
            exit 1
          }
          $chosen = $peFiles | Where-Object { $_.Name -match 'CANgaroo|cangaroo|CAN' } | Select-Object -First 1
          if (-not $chosen) { $chosen = $peFiles | Sort-Object Length | Select-Object -Last 1 }
          Write-Host "Chosen PE file: $($chosen.FullName) (size $($chosen.Length))"
          $outExePath = Join-Path -Path (Split-Path -Parent $chosen.FullName) -ChildPath 'CANgaroo.exe'
          Copy-Item -Path $chosen.FullName -Destination $outExePath -Force
          Write-Host "Copied to $outExePath"
          $hash = (Get-FileHash -Path $chosen.FullName -Algorithm SHA256).Hash
          $firstBytes = Get-Content -Path $chosen.FullName -Encoding Byte -TotalCount 128
          $hex = ($firstBytes | ForEach-Object { $_.ToString("X2") }) -join ' '
          $info = @("OriginalPath=$($chosen.FullName)","OriginalName=$($chosen.Name)","ChosenSize=$($chosen.Length)","ChosenSHA256=$hash","First128BytesHex=$hex")
          $infoPath = Join-Path -Path (Split-Path -Parent $chosen.FullName) -ChildPath 'candidate-info.txt'
          $info | Out-File -FilePath $infoPath -Encoding UTF8
          echo "exe=$outExePath" | Out-File -Encoding UTF8 -FilePath $env:GITHUB_OUTPUT -Append
          echo "candidate=$($chosen.FullName)" | Out-File -Encoding UTF8 -FilePath $env:GITHUB_OUTPUT -Append
          echo "candidate_info=$infoPath" | Out-File -Encoding UTF8 -FilePath $env:GITHUB_OUTPUT -Append
        shell: pwsh

      - name: Upload candidate binary & diagnostics (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: candidate-binary
          path: |
            ${{ steps.find-exe.outputs.candidate }}
            ${{ steps.find-exe.outputs.candidate_info }}

      - name: Run windeployqt to collect Qt runtime
        run: |
          $exe = "${{ steps.find-exe.outputs.exe }}"
          $outdir = Join-Path -Path (Split-Path -Parent $exe) -ChildPath 'cangaroo_deploy'
          if (-not (Test-Path $outdir)) { New-Item -ItemType Directory -Path $outdir | Out-Null }
          windeployqt --release --dir "$outdir" "$exe"
          Copy-Item -Path "$exe" -Destination (Join-Path $outdir 'CANgaroo.exe') -Force
          Write-Host "Deployment folder prepared at: $outdir"
        shell: pwsh

      - name: Archive deploy folder
        run: |
          $outdir = Get-ChildItem -Path . -Directory -Recurse | Where-Object { $_.Name -eq 'cangaroo_deploy' } | Select-Object -First 1
          if (-not $outdir) { Write-Error 'Deploy folder not found'; exit 1 }
          $zip = 'CANgaroo-Windows.zip'
          Remove-Item -Path $zip -ErrorAction Ignore
          Compress-Archive -Path "$($outdir.FullName)\*" -DestinationPath $zip -Force
          Write-Host "Created $zip"
        shell: pwsh

      - name: Upload deploy zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: CANgaroo-windows
          path: CANgaroo-Windows.zip

      - name: Upload build logs (if failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cangaroo-build-logs
          path: |
            **/*.log
            **/CMakeFiles/**/CMakeOutput.log
